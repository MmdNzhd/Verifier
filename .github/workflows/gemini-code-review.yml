name: Gemini AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  gemini-review:
    name: Gemini Code Review
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: |
            **/*.cs
            **/*.csproj
            **/*.cshtml
            **/*.config
            **/*.json
            **/*.sql

      - name: Setup Python
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        if: steps.changed-files.outputs.any_changed == 'true'
        run: pip install google-generativeai requests

      - name: Read PR info
        if: steps.changed-files.outputs.any_changed == 'true'
        id: pr-info
        run: |
          echo "pr_number=$(cat $GITHUB_EVENT_PATH | python3 -c 'import sys, json; print(json.load(sys.stdin)["pull_request"]["number"])')" >> $GITHUB_OUTPUT
          echo "pr_title=$(cat $GITHUB_EVENT_PATH | python3 -c 'import sys, json; print(json.load(sys.stdin)["pull_request"]["title"])')" >> $GITHUB_OUTPUT
          echo "pr_author=$(cat $GITHUB_EVENT_PATH | python3 -c 'import sys, json; print(json.load(sys.stdin)["pull_request"]["user"]["login"])')" >> $GITHUB_OUTPUT

      - name: Run Gemini Code Review
        if: steps.changed-files.outputs.any_changed == 'true'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.pr-info.outputs.pr_number }}
          PR_TITLE: ${{ steps.pr-info.outputs.pr_title }}
          PR_AUTHOR: ${{ steps.pr-info.outputs.pr_author }}
        run: |
          python3 << 'PYTHON_SCRIPT'
          import os
          import sys
          import json
          import google.generativeai as genai
          import requests
          from datetime import datetime

          # Configure Gemini API
          genai.configure(api_key=os.environ['GEMINI_API_KEY'])
          
          # Use the correct model name
          model = genai.GenerativeModel('gemini-2.0-flash-exp')

          github_token = os.environ['GITHUB_TOKEN']
          repo = os.environ['GITHUB_REPOSITORY']
          pr_number = os.environ['PR_NUMBER']
          pr_title = os.environ['PR_TITLE']
          pr_author = os.environ['PR_AUTHOR']

          headers = {
              'Authorization': f'token {github_token}',
              'Accept': 'application/vnd.github.v3.diff'
          }

          def get_diff():
              """Fetch the PR diff from GitHub API"""
              diff_url = f'https://api.github.com/repos/{repo}/pulls/{pr_number}'
              try:
                  response = requests.get(diff_url, headers=headers, timeout=30)
                  response.raise_for_status()
                  return response.text
              except requests.exceptions.RequestException as e:
                  print(f"Error fetching diff: {str(e)}")
                  return None

          def create_prompt(chunk_num, total_chunks, diff_content):
              """Create the review prompt for Gemini"""
              # Use triple quotes to avoid escaping issues
              return f"""You are a senior .NET Core architect and security expert.

          CONTEXT:
          - Repository: {repo}
          - PR Number: {pr_number}
          - PR Title: {pr_title}
          - Author: {pr_author}
          - This is chunk {chunk_num} of {total_chunks}

          REVIEW SCOPE:
          - Security vulnerabilities (SQL injection, XSS, authentication issues)
          - Performance issues (N+1 queries, memory leaks, inefficient algorithms)
          - Code quality and best practices (.NET conventions, SOLID principles)
          - Bugs and logical errors
          - Missing error handling and validation

          Please provide:
          1. Critical issues (must fix)
          2. Suggestions for improvement
          3. Positive feedback on good practices

          Code Diff (chunk {chunk_num} of {total_chunks}):
          {diff_content}

          Format your response in clear markdown with sections for each type of issue.
          """

          def review_chunk(chunk_num, total_chunks, chunk):
              """Review a single chunk of code"""
              prompt = create_prompt(chunk_num, total_chunks, chunk)
              generation_config = {
                  "temperature": 0.1,
                  "top_p": 0.9,
                  "top_k": 64,
                  "max_output_tokens": 8192
              }
              
              try:
                  response = model.generate_content(
                      prompt, 
                      generation_config=generation_config
                  )
                  
                  if response and hasattr(response, 'text') and response.text:
                      return f"## Section {chunk_num}/{total_chunks}\n\n{response.text}"
                  else:
                      return f"## Section {chunk_num}/{total_chunks}\n\n*No issues found*"
                      
              except Exception as e:
                  error_msg = str(e)
                  print(f"Error reviewing chunk {chunk_num}: {error_msg}")
                  return f"## Section {chunk_num}/{total_chunks}\n\n**Error during review**: {error_msg}"

          def post_review(review_body):
              """Post the review to GitHub PR"""
              review_url = f'https://api.github.com/repos/{repo}/pulls/{pr_number}/reviews'
              review_data = {
                  'body': review_body,
                  'event': 'COMMENT'
              }
              review_headers = {
                  'Authorization': f'token {github_token}',
                  'Accept': 'application/vnd.github.v3+json',
                  'Content-Type': 'application/json'
              }
              
              try:
                  response = requests.post(
                      review_url, 
                      headers=review_headers, 
                      data=json.dumps(review_data), 
                      timeout=60
                  )
                  response.raise_for_status()
                  print("âœ“ Gemini review posted successfully!")
                  return True
              except requests.exceptions.RequestException as e:
                  print(f"âœ— Failed to post review: {str(e)}")
                  if hasattr(e, 'response') and e.response is not None:
                      print(f"Response body: {e.response.text}")
                  return False

          def main():
              """Main execution function"""
              print(f"Starting Gemini Code Review for PR #{pr_number}")
              
              # Fetch diff
              diff_content = get_diff()
              if diff_content is None:
                  print("âœ— Failed to fetch diff")
                  sys.exit(1)
                  
              if not diff_content.strip():
                  print("âœ“ No changes to review")
                  sys.exit(0)

              # Split into chunks if needed
              MAX_CHUNK_SIZE = 400000  # Conservative limit for Gemini
              chunks = []
              
              if len(diff_content) <= MAX_CHUNK_SIZE:
                  chunks = [diff_content]
              else:
                  for i in range(0, len(diff_content), MAX_CHUNK_SIZE):
                      chunks.append(diff_content[i:i+MAX_CHUNK_SIZE])
              
              print(f"Processing {len(chunks)} chunk(s)...")

              # Review each chunk
              all_reviews = []
              for idx, chunk in enumerate(chunks, start=1):
                  print(f"Reviewing chunk {idx}/{len(chunks)}...")
                  review_text = review_chunk(idx, len(chunks), chunk)
                  all_reviews.append(review_text)

              # Compile final review
              timestamp = datetime.utcnow().strftime('%Y-%m-%d %H:%M UTC')
              final_review = f"""## ðŸ¤– Gemini AI Code Review

          **PR**: #{pr_number} - {pr_title}  
          **Author**: @{pr_author}  
          **Review Date**: {timestamp}

          ---

          {chr(10).join([f"{review}{chr(10)}---{chr(10)}" for review in all_reviews])}

          ---

          *Powered by Gemini 2.0 Flash â€¢ [Configure Review Settings](https://github.com/{repo}/settings/secrets/actions)*
          """

              # Post review
              if post_review(final_review):
                  print("âœ“ Review process completed successfully")
                  sys.exit(0)
              else:
                  print("âœ— Review process failed")
                  sys.exit(1)

          if __name__ == "__main__":
              main()
          PYTHON_SCRIPT

      - name: No changes to review
        if: steps.changed-files.outputs.any_changed != 'true'
        run: echo "âœ“ No relevant files were changed in this PR."
